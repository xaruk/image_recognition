# 画面テキスト監視システム

画面上の指定領域を監視し、リアルタイムでテキストを認識するRustアプリケーションです。

## 機能

- 画面上の任意の領域を指定して監視
- リアルタイムOCR（光学文字認識）によるテキスト抽出
- テキストの変化を検出して通知
- 日本語・英語のテキスト認識対応
- 認識履歴の表示

## 必要な環境

### システム要件

- **OS**: macOS, Windows, Linux
- **Rust**: 1.70以上
- **Tesseract OCR**: 4.0以上

### Tesseractのインストール

#### macOS
```bash
brew install tesseract
brew install tesseract-lang  # 日本語データを含む言語パック
```

#### Ubuntu/Debian
```bash
sudo apt-get update
sudo apt-get install tesseract-ocr
sudo apt-get install tesseract-ocr-jpn  # 日本語データ
```

#### Windows
1. [Tesseract公式サイト](https://github.com/UB-Mannheim/tesseract/wiki)からインストーラーをダウンロード
2. インストール時に日本語データを選択
3. 環境変数PATHにTesseractのbinディレクトリを追加

## ビルドと実行

### 依存関係のインストールとビルド
```bash
# プロジェクトディレクトリに移動
cd /Users/user/Documents/proj/rust/image_recognition

# ビルド
cargo build --release
```

### 実行
```bash
# デバッグモードで実行（ログ出力あり）
RUST_LOG=info cargo run

# リリースモードで実行
cargo run --release
```

## 使い方

1. **アプリケーションを起動**
   ```bash
   cargo run
   ```

2. **監視領域の選択**
   - 「領域を選択」ボタンをクリック
   - macOSのスクリーンショット機能（Cmd + Shift + 5）のような操作
     - 画面全体が半透明の暗いオーバーレイで覆われます
     - マウスカーソルが十字型に変わります
     - ドラッグで監視したい領域を選択（点線で範囲が表示されます）
     - 選択中は点線の矩形をドラッグで自由に拡大・縮小可能
     - 「領域確定」ボタンまたはEnterキーで確定

3. **監視の開始**
   - 「監視を開始」ボタンをクリック
   - 指定領域のテキストが500ms間隔で認識されます

4. **結果の確認**
   - 認識されたテキストは履歴として表示されます
   - 新規テキスト、変更、クリアのイベントが記録されます

## トラブルシューティング

### Tesseractが見つからないエラー
```
Error: Tesseractの初期化に失敗しました
```
- Tesseractが正しくインストールされているか確認
- 環境変数PATHにTesseractが含まれているか確認
- `tesseract --version`コマンドで動作確認

### 日本語が認識されない
- 日本語データ（jpn.traineddata）がインストールされているか確認
- macOS: `ls /opt/homebrew/share/tessdata/jpn.traineddata`
- Ubuntu: `ls /usr/share/tesseract-ocr/4.00/tessdata/jpn.traineddata`
- 日本語データがない場合は自動的に英語モードで動作します

### 画面キャプチャの権限エラー（macOS）
- システム環境設定 > セキュリティとプライバシー > プライバシー > 画面収録
- ターミナルまたはアプリケーションに権限を付与

## 修正済みの問題

### バスエラー（Bus Error 10）の修正
- **問題**: macOSでアプリケーション起動時にバスエラーが発生
- **原因**: tokioの非同期ランタイムとeframeのイベントループの競合
- **解決**: 標準スレッドを使用した同期処理に変更

### 監視制御の改善
- ✅ 監視の開始・停止機能を実装
- ✅ 適切なスレッド終了処理を追加
- ✅ エラーハンドリングの改善

### GUI文字化け問題の修正
- **問題**: 日本語文字が正しく表示されない
- **解決**: システムのデフォルトフォントを使用するように変更

### OCR言語データの問題
- **問題**: Tesseractの日本語データが見つからない
- **解決**: 日本語データがない場合は自動的に英語モードで動作

### 日本語+英語OCR対応
- ✅ `jpn+eng`による複数言語認識を実装
- ✅ 日本語を優先し、英語も同時に認識
- ✅ 自動フォールバック機能（jpn+eng → jpn → eng）

## 領域選択インターフェース仕様

### 現在の問題点
- 領域選択時の画面が不透明な白い画面になっており、実際にどの部分が記録されるか確認できない
- macOSで最大化すると別のウィンドウに切り替わってしまう

### 新仕様（macOSのスクリーンショット機能準拠）
1. **領域選択開始時**
   - 画面全体に半透明の暗いオーバーレイを表示
   - 既存のウィンドウは透けて見える状態を維持
   - カーソルが十字型に変化

2. **領域選択中**
   - ドラッグで矩形選択
   - 選択範囲は点線で表示
   - リアルタイムでサイズ表示（幅 x 高さ）
   - 選択範囲内は明るく、外側は暗く表示

3. **領域調整**
   - 選択後も点線の矩形の辺や角をドラッグして調整可能
   - カーソルが範囲の辺に近づくとリサイズカーソルに変化

4. **確定操作**
   - 「領域確定」ボタンのクリック
   - またはEnterキーの押下
   - Escキーで選択をキャンセル

## 今後の実装予定

- [x] マウスドラッグによる領域選択機能（新仕様で実装予定）
- [ ] 設定の保存・読み込み機能
- [ ] 複数領域の同時監視
- [ ] テキスト読み上げ機能
- [ ] より高度なテキスト差分検出
- [ ] パフォーマンスの最適化

## ライセンス

MIT License